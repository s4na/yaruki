<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå®‰å®šæ€§ãƒ†ã‚¹ãƒˆ</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        .test-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            max-height: 600px;
            background: white;
            border: 2px solid #4f46e5;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }

        .test-panel h3 {
            margin-top: 0;
            color: #4f46e5;
        }

        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 6px;
            background: #f5f7fa;
        }

        .test-result.pass {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .test-result.fail {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .test-result.info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .measurement-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 11px;
        }

        .measurement-table th,
        .measurement-table td {
            border: 1px solid #ddd;
            padding: 5px;
            text-align: right;
        }

        .measurement-table th {
            background: #f5f7fa;
            font-weight: bold;
        }

        .button-group {
            margin: 15px 0;
            display: flex;
            gap: 10px;
        }

        .test-button {
            flex: 1;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: #4f46e5;
            color: white;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .test-button:hover {
            background: #4338ca;
        }

        .measurement-value {
            font-weight: bold;
            color: #4f46e5;
        }

        .variance-high {
            color: #dc3545;
            font-weight: bold;
        }

        .variance-low {
            color: #28a745;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ§­ è¡Œå‹•ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³</h1>
            <p class="tagline">Yes/No ã ã‘ã§ã€Œæ¬¡ã®ä¸€æ­©ã€ãŒè¦‹ãˆã‚‹</p>
            <p class="subtitle">ã‚ãªãŸã®è¡Œå‹•ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ã„ã‚‹ç†ç”±ã‚’ä¸€ç·’ã«è¦‹ã¤ã‘ã¾ã—ã‚‡ã†</p>
        </header>

        <main id="app">
            <div id="question-container" class="question-section">
                <div class="progress-container">
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-fill"></div>
                    </div>
                    <p id="progress-text" class="progress-text">è³ªå• <span id="current-step">1</span>/7</p>
                </div>

                <div class="question-box">
                    <div class="question-counter">è³ªå•ã«ç­”ãˆã¦ã€æ¬¡ã®ä¸€æ­©ã‚’è¦‹ã¤ã‘ã‚‹</div>
                    <h2 id="question-text"></h2>

                    <div class="button-group">
                        <button id="yes-btn" class="btn btn-yes">
                            <span class="btn-label">Yes</span>
                            <span class="btn-sublabel">ãã†æ€ã†</span>
                        </button>
                        <button id="no-btn" class="btn btn-no">
                            <span class="btn-label">No</span>
                            <span class="btn-sublabel">ãã†ã§ã‚‚ãªã„</span>
                        </button>
                    </div>
                </div>
            </div>

            <div id="result-container" class="result-section hidden">
                <div class="result-box">
                    <div class="result-icon">ğŸ’¡</div>
                    <h2 id="result-title">ã‚ãªãŸã®æ¬¡ã®ä¸€æ­©</h2>

                    <div class="action-section">
                        <div id="action-content" class="action-content"></div>
                    </div>

                    <div class="cta-section">
                        <p class="encouragement">ã“ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å®Ÿè¡Œã—ã¦ã€å°ã•ãå§‹ã‚ã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ</p>
                        <button id="restart-btn" class="btn btn-restart">åˆ¥ã®è¦–ç‚¹ã§è¦‹ç›´ã™</button>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <p>ã‚·ãƒ³ãƒ—ãƒ«ãª Yes/No ã ã‘ã§ã€è¡Œå‹•ã®ãƒ–ãƒ­ãƒƒã‚«ãƒ¼ã‚’åˆ†æã—ã¾ã™</p>
        </footer>
    </div>

    <!-- Test Panel -->
    <div class="test-panel">
        <h3>ğŸ§ª ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ†ã‚¹ãƒˆ</h3>

        <div class="button-group">
            <button class="test-button" onclick="runLayoutTests()">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
            <button class="test-button" onclick="startMonitoring()">ç›£è¦–é–‹å§‹</button>
            <button class="test-button" onclick="stopMonitoring()">ç›£è¦–åœæ­¢</button>
        </div>

        <div id="test-results"></div>
    </div>

    <script src="../script.js"></script>
    <script>
        /**
         * ç°¡æ˜“ç‰ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ†ã‚¹ãƒˆï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”¨ï¼‰
         */
        class LayoutMonitor {
            constructor() {
                this.measurements = [];
                this.monitoring = false;
                this.monitorInterval = null;
            }

            measure() {
                const questionBox = document.querySelector('.question-box');
                const buttonGroup = document.querySelector('.button-group');

                if (!questionBox || !buttonGroup) {
                    return null;
                }

                const rect = buttonGroup.getBoundingClientRect();
                const questionRect = questionBox.getBoundingClientRect();

                return {
                    timestamp: Date.now(),
                    buttonGroupTop: Math.round(rect.top),
                    buttonGroupHeight: Math.round(rect.height),
                    questionBoxHeight: Math.round(questionRect.height),
                    windowHeight: window.innerHeight,
                };
            }

            record(questionId) {
                const measurement = this.measure();
                if (measurement) {
                    measurement.questionId = questionId;
                    this.measurements.push(measurement);
                }
            }

            checkStability(tolerance = 5) {
                if (this.measurements.length < 2) {
                    return {
                        isStable: true,
                        variance: 0,
                        message: 'ãƒ†ã‚¹ãƒˆä¸è¶³',
                        measurements: this.measurements,
                    };
                }

                const tops = this.measurements.map(m => m.buttonGroupTop);
                const minTop = Math.min(...tops);
                const maxTop = Math.max(...tops);
                const variance = maxTop - minTop;
                const isStable = variance <= tolerance;

                return {
                    isStable,
                    variance,
                    tolerance,
                    minTop,
                    maxTop,
                    measurements: this.measurements,
                    message: isStable
                        ? `âœ“ å®‰å®šã—ã¦ã„ã‚‹ï¼ˆå·®: ${variance}pxã€è¨±å®¹å€¤: ${tolerance}pxï¼‰`
                        : `âœ— ä¸å®‰å®šï¼ˆå·®: ${variance}px > è¨±å®¹å€¤: ${tolerance}pxï¼‰`,
                };
            }

            checkHeightConsistency(tolerance = 2) {
                if (this.measurements.length < 2) {
                    return {
                        isConsistent: true,
                        heightVariance: 0,
                        message: 'ãƒ†ã‚¹ãƒˆä¸è¶³',
                    };
                }

                const heights = this.measurements.map(m => m.buttonGroupHeight);
                const minHeight = Math.min(...heights);
                const maxHeight = Math.max(...heights);
                const heightVariance = maxHeight - minHeight;
                const isConsistent = heightVariance <= tolerance;

                return {
                    isConsistent,
                    heightVariance,
                    tolerance,
                    minHeight,
                    maxHeight,
                    message: isConsistent
                        ? `âœ“ é«˜ã•ãŒä¸€å®šï¼ˆå·®: ${heightVariance}pxï¼‰`
                        : `âœ— é«˜ã•ãŒå¤‰å‹•ï¼ˆå·®: ${heightVariance}pxï¼‰`,
                };
            }

            clear() {
                this.measurements = [];
            }
        }

        const monitor = new LayoutMonitor();
        let currentQuestionId = 'q1';

        function recordMeasurement() {
            monitor.record(currentQuestionId);
        }

        function startMonitoring() {
            monitor.clear();
            monitor.monitoring = true;
            monitor.monitorInterval = setInterval(recordMeasurement, 100);
            showResult('info', 'ç›£è¦–é–‹å§‹ã—ã¾ã—ãŸï¼ˆ100msé–“éš”ï¼‰');
        }

        function stopMonitoring() {
            if (monitor.monitorInterval) {
                clearInterval(monitor.monitorInterval);
            }
            monitor.monitoring = false;

            const stability = monitor.checkStability();
            const heightConsistency = monitor.checkHeightConsistency();

            displayResults(stability, heightConsistency);
        }

        function runLayoutTests() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '';

            // Test 1: DOMè¦ç´ ç¢ºèª
            showResult(
                document.querySelector('.question-box') ? 'pass' : 'fail',
                'DOMç¢ºèª: .question-box'
            );
            showResult(
                document.querySelector('.button-group') ? 'pass' : 'fail',
                'DOMç¢ºèª: .button-group'
            );

            // Test 2: CSS ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ç¢ºèª
            const questionBox = document.querySelector('.question-box');
            const questionSection = document.querySelector('.question-section');
            const buttonGroup = document.querySelector('.button-group');

            const boxDisplay = window.getComputedStyle(questionBox).display;
            const sectionDisplay = window.getComputedStyle(questionSection).display;
            const groupShrink = window.getComputedStyle(buttonGroup).flexShrink;

            showResult(
                boxDisplay === 'flex' ? 'pass' : 'fail',
                `CSS: .question-box ã¯ flexï¼ˆå®Ÿéš›: ${boxDisplay}ï¼‰`
            );

            showResult(
                sectionDisplay === 'flex' ? 'pass' : 'fail',
                `CSS: .question-section ã¯ flexï¼ˆå®Ÿéš›: ${sectionDisplay}ï¼‰`
            );

            showResult(
                groupShrink === '0' ? 'pass' : 'fail',
                `CSS: .button-group flex-shrink: 0ï¼ˆå®Ÿéš›: ${groupShrink}ï¼‰`
            );

            // Test 3: ç¾åœ¨ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ¸¬å®š
            showResult('info', 'ç¾åœ¨ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ¸¬å®š:');
            const measurement = monitor.measure();
            if (measurement) {
                showResult(
                    'info',
                    `ãƒœã‚¿ãƒ³ãƒˆãƒƒãƒ—ä½ç½®: <span class="measurement-value">${measurement.buttonGroupTop}px</span>`
                );
                showResult(
                    'info',
                    `ãƒœã‚¿ãƒ³é«˜ã•: <span class="measurement-value">${measurement.buttonGroupHeight}px</span>`
                );
                showResult(
                    'info',
                    `è³ªå•ãƒœãƒƒã‚¯ã‚¹é«˜ã•: <span class="measurement-value">${measurement.questionBoxHeight}px</span>`
                );
            }
        }

        function displayResults(stability, heightConsistency) {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '';

            // ãƒœã‚¿ãƒ³ä½ç½®ã®å®‰å®šæ€§
            showResult(
                stability.isStable ? 'pass' : 'fail',
                `ãƒœã‚¿ãƒ³ä½ç½®ã®å®‰å®šæ€§: ${stability.message}`
            );

            if (stability.measurements.length > 0) {
                showResult(
                    'info',
                    `æœ€å°ä½ç½®: ${stability.minTop}px / æœ€å¤§ä½ç½®: ${stability.maxTop}px`
                );

                // ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º
                let tableHtml = '<table class="measurement-table"><thead><tr><th>è³ªå•</th><th>Top</th><th>Height</th></tr></thead><tbody>';
                stability.measurements.forEach(m => {
                    tableHtml += `<tr><td>${m.questionId || 'N/A'}</td><td>${m.buttonGroupTop}</td><td>${m.buttonGroupHeight}</td></tr>`;
                });
                tableHtml += '</tbody></table>';
                resultsDiv.innerHTML += tableHtml;
            }

            // ãƒœã‚¿ãƒ³é«˜ã•ã®ä¸€è²«æ€§
            showResult(
                heightConsistency.isConsistent ? 'pass' : 'fail',
                `ãƒœã‚¿ãƒ³é«˜ã•ã®ä¸€è²«æ€§: ${heightConsistency.message}`
            );

            if (heightConsistency.minHeight !== undefined) {
                showResult(
                    'info',
                    `æœ€å°é«˜ã•: ${heightConsistency.minHeight}px / æœ€å¤§é«˜ã•: ${heightConsistency.maxHeight}px`
                );
            }
        }

        function showResult(type, message) {
            const resultsDiv = document.getElementById('test-results');
            const resultEl = document.createElement('div');
            resultEl.className = `test-result ${type}`;
            resultEl.innerHTML = message;
            resultsDiv.appendChild(resultEl);
        }

        // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ã‚¯ã‚¨ã‚¹ãƒãƒ§ãƒ³IDã‚’æ›´æ–°
        const yesBtn = document.getElementById('yes-btn');
        const noBtn = document.getElementById('no-btn');

        if (yesBtn) {
            const originalYesClick = yesBtn.onclick;
            yesBtn.addEventListener('click', () => {
                // æ¬¡ã®questionIdã‚’æ¨æ¸¬ï¼ˆç°¡æ˜“ç‰ˆï¼‰
                const currentStep = parseInt(document.getElementById('current-step')?.textContent || '1');
                currentQuestionId = `q${currentStep + 1}`;
                recordMeasurement();
            });
        }

        if (noBtn) {
            const originalNoClick = noBtn.onclick;
            noBtn.addEventListener('click', () => {
                recordMeasurement();
            });
        }

        console.log('ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ†ã‚¹ãƒˆãƒ‘ãƒãƒ«ãŒæº–å‚™ã§ãã¾ã—ãŸ');
        console.log('ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã‹ã€ä»¥ä¸‹ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œ:');
        console.log('  runLayoutTests()  - ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ');
        console.log('  startMonitoring() - ç›£è¦–é–‹å§‹');
        console.log('  stopMonitoring()  - ç›£è¦–åœæ­¢');
    </script>
</body>
</html>
